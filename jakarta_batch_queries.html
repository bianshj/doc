<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jakarta Batch æŸ¥è¯¢å’Œæ•°æ®æ’å…¥æŒ‡å—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        .content {
            padding: 40px;
        }
        .section {
            margin-bottom: 50px;
        }
        .section h2 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        .subsection {
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .subsection h3 {
            color: #764ba2;
            font-size: 1.3em;
            margin-bottom: 15px;
        }
        .description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.8;
        }
        code {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }
        .code-block code {
            background: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
        }
        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            color: #856404;
        }
        .tip {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            color: #0c5460;
        }
        .table-wrapper {
            overflow-x: auto;
            margin: 15px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        table tr:hover {
            background: #f5f5f5;
        }
        .highlight {
            background: #ffeb3b;
            padding: 2px 4px;
            border-radius: 2px;
        }
        footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #666;
            border-top: 1px solid #ddd;
        }
        .example-title {
            font-weight: bold;
            color: #764ba2;
            margin-top: 15px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš€ Jakarta Batch æŸ¥è¯¢å’Œæ•°æ®æ“ä½œå®Œå…¨æŒ‡å—</h1>
            <p>æ¶µç›– @NamedQueryã€@NamedNativeQueryã€å‚æ•°æŸ¥è¯¢ã€å¤šè¡¨è”åˆã€æ•°æ®æ’å…¥ç­‰å¸¸ç”¨æ–¹æ³•</p>
        </header>

        <div class="content">
            <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€æ¦‚å¿µ -->
            <div class="section">
                <h2>ğŸ“š ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€æ¦‚å¿µ</h2>
                
                <div class="subsection">
                    <h3>ä»€ä¹ˆæ˜¯ @NamedQuery å’Œ @NamedNativeQueryï¼Ÿ</h3>
                    <div class="description">
                        <strong>@NamedQueryï¼š</strong> ä½¿ç”¨ JPQLï¼ˆJava Persistence Query Languageï¼‰ç¼–å†™çš„å‘½åæŸ¥è¯¢ï¼Œæä¾›ç±»å‹å®‰å…¨å’Œç¼–è¯‘æ—¶æ£€æŸ¥ã€‚
                        <br><br>
                        <strong>@NamedNativeQueryï¼š</strong> ä½¿ç”¨åŸç”Ÿ SQL ç¼–å†™çš„å‘½åæŸ¥è¯¢ï¼Œå…·æœ‰æ›´é«˜çš„æ€§èƒ½å’Œçµæ´»æ€§ã€‚
                        <br><br>
                        ä¸¤è€…éƒ½åœ¨å®ä½“ç±»ä¸Šå®šä¹‰ï¼Œåœ¨ Batch å¤„ç†ä¸­å¯ä»¥æ˜¾è‘—æå‡æ•ˆç‡ã€‚
                    </div>
                </div>
            </div>

            <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“å®šä¹‰ -->
            <div class="section">
                <h2>ğŸ—ï¸ ç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“å®šä¹‰å’ŒåŸºç¡€æŸ¥è¯¢</h2>
                
                <div class="subsection">
                    <h3>1. å®šä¹‰åŸºç¡€å®ä½“ç±»</h3>
                    <div class="description">ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŒ…å«å„ç§æŸ¥è¯¢æ³¨è§£çš„å®Œæ•´å®ä½“å®šä¹‰ï¼š</div>
                    <div class="code-block"><code>import jakarta.persistence.*;

@Entity
@Table(name = "users")
@NamedQuery(
    name = "User.findAll",
    query = "SELECT u FROM User u"
)
@NamedQuery(
    name = "User.findById",
    query = "SELECT u FROM User u WHERE u.id = :id"
)
@NamedQuery(
    name = "User.findByName",
    query = "SELECT u FROM User u WHERE u.name LIKE :name"
)
@NamedQuery(
    name = "User.findByAge",
    query = "SELECT u FROM User u WHERE u.age > :age ORDER BY u.age DESC"
)
@NamedQuery(
    name = "User.countAll",
    query = "SELECT COUNT(u) FROM User u"
)
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String name;
    
    @Column(unique = true)
    private String email;
    
    private Integer age;
    
    @Column(name = "create_time")
    private LocalDateTime createTime;
    
    // Getters and Setters...
}</code></div>
                </div>

                <div class="subsection">
                    <h3>2. åŸç”Ÿ SQL æŸ¥è¯¢å®šä¹‰</h3>
                    <div class="description">ä½¿ç”¨ @NamedNativeQuery æ‰§è¡ŒåŸç”Ÿ SQLï¼š</div>
                    <div class="code-block"><code>@Entity
@Table(name = "users")
@NamedNativeQuery(
    name = "User.findAllNative",
    query = "SELECT * FROM users",
    resultClass = User.class
)
@NamedNativeQuery(
    name = "User.findActiveUsers",
    query = "SELECT * FROM users WHERE age > :minAge AND status = 'ACTIVE'",
    resultClass = User.class
)
public class User {
    // å­—æ®µå®šä¹‰...
}</code></div>
                </div>
            </div>

            <!-- ç¬¬ä¸‰éƒ¨åˆ†ï¼šå‚æ•°æŸ¥è¯¢ -->
            <div class="section">
                <h2>ğŸ” ç¬¬ä¸‰éƒ¨åˆ†ï¼šå‚æ•°æŸ¥è¯¢ï¼ˆé‡ç‚¹ï¼‰</h2>
                
                <div class="subsection">
                    <h3>1. å•å‚æ•°æŸ¥è¯¢</h3>
                    <div class="code-block"><code>@NamedQuery(
    name = "User.findByEmail",
    query = "SELECT u FROM User u WHERE u.email = :email"
)
public class User {
    // ...
}

// ä½¿ç”¨æ–¹å¼
TypedQuery&lt;User&gt; query = em.createNamedQuery("User.findByEmail", User.class);
query.setParameter("email", "user@example.com");
User user = query.getSingleResult();</code></div>
                </div>

                <div class="subsection">
                    <h3>2. å¤šå‚æ•°æŸ¥è¯¢</h3>
                    <div class="code-block"><code>@NamedQuery(
    name = "User.findByAgeRange",
    query = "SELECT u FROM User u WHERE u.age BETWEEN :minAge AND :maxAge ORDER BY u.age"
)
public class User {
    // ...
}

// ä½¿ç”¨æ–¹å¼
TypedQuery&lt;User&gt; query = em.createNamedQuery("User.findByAgeRange", User.class);
query.setParameter("minAge", 20);
query.setParameter("maxAge", 50);
List&lt;User&gt; users = query.getResultList();</code></div>
                </div>

                <div class="subsection">
                    <h3>3. IN å­å¥æŸ¥è¯¢</h3>
                    <div class="code-block"><code>@NamedQuery(
    name = "User.findByIds",
    query = "SELECT u FROM User u WHERE u.id IN (:ids)"
)
public class User {
    // ...
}

// ä½¿ç”¨æ–¹å¼
List&lt;Long&gt; userIds = Arrays.asList(1L, 2L, 3L, 4L, 5L);
TypedQuery&lt;User&gt; query = em.createNamedQuery("User.findByIds", User.class);
query.setParameter("ids", userIds);
List&lt;User&gt; users = query.getResultList();</code></div>
                </div>

                <div class="subsection">
                    <h3>4. LIKE æ¨¡ç³ŠæŸ¥è¯¢</h3>
                    <div class="code-block"><code>@NamedQuery(
    name = "User.searchByName",
    query = "SELECT u FROM User u WHERE u.name LIKE :searchName"
)
public class User {
    // ...
}

// ä½¿ç”¨æ–¹å¼
TypedQuery&lt;User&gt; query = em.createNamedQuery("User.searchByName", User.class);
query.setParameter("searchName", "%John%");
List&lt;User&gt; users = query.getResultList();</code></div>
                </div>
            </div>

            <!-- ç¬¬å››éƒ¨åˆ†ï¼šå¤šè¡¨è”åˆæŸ¥è¯¢ -->
            <div class="section">
                <h2>ğŸ”— ç¬¬å››éƒ¨åˆ†ï¼šå¤šè¡¨è”åˆæŸ¥è¯¢</h2>
                
                <div class="subsection">
                    <h3>1. å®šä¹‰ç›¸å…³å®ä½“</h3>
                    <div class="code-block"><code>// éƒ¨é—¨å®ä½“
@Entity
@Table(name = "departments")
public class Department {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String name;
    
    @OneToMany(mappedBy = "department", cascade = CascadeType.ALL)
    private List&lt;User&gt; users = new ArrayList&lt;&gt;();
    
    // Getters and Setters...
}

// ç”¨æˆ·å®ä½“
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String name;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "department_id")
    private Department department;
    
    // Getters and Setters...
}</code></div>
                </div>

                <div class="subsection">
                    <h3>2. INNER JOIN æŸ¥è¯¢</h3>
                    <div class="code-block"><code>@NamedQuery(
    name = "User.findByDepartment",
    query = "SELECT u FROM User u " +
            "INNER JOIN u.department d " +
            "WHERE d.id = :departmentId"
)
public class User {
    // ...
}

// ä½¿ç”¨æ–¹å¼
TypedQuery&lt;User&gt; query = em.createNamedQuery("User.findByDepartment", User.class);
query.setParameter("departmentId", 1L);
List&lt;User&gt; users = query.getResultList();</code></div>
                </div>

                <div class="subsection">
                    <h3>3. LEFT JOIN æŸ¥è¯¢</h3>
                    <div class="code-block"><code>@NamedQuery(
    name = "Department.findWithUsers",
    query = "SELECT d FROM Department d " +
            "LEFT JOIN FETCH d.users u " +
            "WHERE d.id = :departmentId"
)
public class Department {
    // ...
}

// ä½¿ç”¨æ–¹å¼
TypedQuery&lt;Department&gt; query = em.createNamedQuery("Department.findWithUsers", Department.class);
query.setParameter("departmentId", 1L);
Department dept = query.getSingleResult();</code></div>
                </div>

                <div class="subsection">
                    <h3>4. å¤æ‚å¤šè¡¨æŸ¥è¯¢ï¼ˆDTO æŠ•å½±ï¼‰</h3>
                    <div class="code-block"><code>// åˆ›å»º DTO ç±»
public class UserDepartmentDTO {
    private String userName;
    private String departmentName;
    private Integer age;
    
    public UserDepartmentDTO(String userName, String departmentName, Integer age) {
        this.userName = userName;
        this.departmentName = departmentName;
        this.age = age;
    }
    
    // Getters...
}

// å®šä¹‰æŸ¥è¯¢
@NamedQuery(
    name = "User.findUserWithDepartmentDTO",
    query = "SELECT NEW com.example.dto.UserDepartmentDTO(" +
            "u.name, d.name, u.age) " +
            "FROM User u " +
            "INNER JOIN u.department d " +
            "WHERE u.age > :minAge"
)
public class User {
    // ...
}

// ä½¿ç”¨æ–¹å¼
TypedQuery&lt;UserDepartmentDTO&gt; query = 
    em.createNamedQuery("User.findUserWithDepartmentDTO", UserDepartmentDTO.class);
query.setParameter("minAge", 25);
List&lt;UserDepartmentDTO&gt; results = query.getResultList();</code></div>
                </div>

                <div class="subsection">
                    <h3>5. åŸç”Ÿ SQL å¤šè¡¨æŸ¥è¯¢</h3>
                    <div class="code-block"><code>@NamedNativeQuery(
    name = "User.findByDepartmentNative",
    query = "SELECT u.id, u.name, u.email, u.age, u.department_id " +
            "FROM users u " +
            "INNER JOIN departments d ON u.department_id = d.id " +
            "WHERE d.id = :departmentId",
    resultClass = User.class
)
public class User {
    // ...
}

// ä½¿ç”¨æ–¹å¼
TypedQuery&lt;User&gt; query = em.createNamedQuery("User.findByDepartmentNative", User.class);
query.setParameter("departmentId", 1L);
List&lt;User&gt; users = query.getResultList();</code></div>
                </div>
            </div>

            <!-- ç¬¬äº”éƒ¨åˆ†ï¼šæ•°æ®æ’å…¥ -->
            <div class="section">
                <h2>ğŸ“ ç¬¬äº”éƒ¨åˆ†ï¼šæ•°æ®æ’å…¥æ–¹æ³•</h2>
                
                <div class="subsection">
                    <h3>1. å•æ¡æ’å…¥</h3>
                    <div class="code-block"><code>User user = new User();
user.setName("å¼ ä¸‰");
user.setEmail("zhangsan@example.com");
user.setAge(30);
user.setCreateTime(LocalDateTime.now());

EntityManager em = // è·å– EntityManager
EntityTransaction tx = em.getTransaction();
tx.begin();
try {
    em.persist(user);
    tx.commit();
} catch (Exception e) {
    tx.rollback();
    throw e;
}</code></div>
                </div>

                <div class="subsection">
                    <h3>2. æ‰¹é‡æ’å…¥ï¼ˆæ ‡å‡†æ–¹å¼ï¼‰</h3>
                    <div class="code-block"><code>EntityManager em = // è·å– EntityManager
EntityTransaction tx = em.getTransaction();
tx.begin();
try {
    for (int i = 0; i &lt; 1000; i++) {
        User user = new User();
        user.setName("ç”¨æˆ·" + i);
        user.setEmail("user" + i + "@example.com");
        user.setAge(20 + (i % 40));
        user.setCreateTime(LocalDateTime.now());
        
        em.persist(user);
        
        // æ¯ 100 æ¡æäº¤ä¸€æ¬¡
        if ((i + 1) % 100 == 0) {
            em.flush();
            em.clear();
        }
    }
    tx.commit();
} catch (Exception e) {
    tx.rollback();
    throw e;
}</code></div>
                </div>

                <div class="subsection">
                    <h3>3. ä½¿ç”¨åŸç”Ÿ SQL æ‰¹é‡æ’å…¥ï¼ˆé«˜æ€§èƒ½ï¼‰</h3>
                    <div class="code-block"><code>EntityManager em = // è·å– EntityManager
EntityTransaction tx = em.getTransaction();
tx.begin();
try {
    String sql = "INSERT INTO users (name, email, age, create_time) VALUES (?, ?, ?, ?)";
    Query query = em.createNativeQuery(sql);
    
    for (int i = 0; i &lt; 10000; i++) {
        query.setParameter(1, "ç”¨æˆ·" + i);
        query.setParameter(2, "user" + i + "@example.com");
        query.setParameter(3, 20 + (i % 40));
        query.setParameter(4, LocalDateTime.now());
        
        query.executeUpdate();
        
        if ((i + 1) % 500 == 0) {
            em.flush();
            em.clear();
        }
    }
    tx.commit();
} catch (Exception e) {
    tx.rollback();
    throw e;
}</code></div>
                </div>

                <div class="subsection">
                    <h3>4. ä¸å…³è”å®ä½“ä¸€èµ·æ’å…¥</h3>
                    <div class="code-block"><code>EntityManager em = // è·å– EntityManager
EntityTransaction tx = em.getTransaction();
tx.begin();
try {
    // å…ˆè·å–æˆ–åˆ›å»ºéƒ¨é—¨
    Department department = em.find(Department.class, 1L);
    if (department == null) {
        department = new Department();
        department.setName("æŠ€æœ¯éƒ¨");
        em.persist(department);
    }
    
    // åˆ›å»ºç”¨æˆ·å¹¶å…³è”éƒ¨é—¨
    User user = new User();
    user.setName("æå››");
    user.setEmail("lisi@example.com");
    user.setAge(28);
    user.setCreateTime(LocalDateTime.now());
    user.setDepartment(department);
    
    em.persist(user);
    tx.commit();
} catch (Exception e) {
    tx.rollback();
    throw e;
}</code></div>
                </div>

                <div class="subsection">
                    <h3>5. æ‰¹é‡æ’å…¥å…³è”æ•°æ®</h3>
                    <div class="code-block"><code>EntityManager em = // è·å– EntityManager
EntityTransaction tx = em.getTransaction();
tx.begin();
try {
    Department department = em.find(Department.class, 1L);
    
    for (int i = 0; i &lt; 500; i++) {
        User user = new User();
        user.setName("å‘˜å·¥" + i);
        user.setEmail("emp" + i + "@example.com");
        user.setAge(20 + (i % 45));
        user.setCreateTime(LocalDateTime.now());
        user.setDepartment(department);
        
        em.persist(user);
        
        if ((i + 1) % 50 == 0) {
            em.flush();
            em.clear();
            // é‡æ–°å…³è” departmentï¼Œå› ä¸º clear() ä¼šæ¸…ç©ºæŒä¹…åŒ–ä¸Šä¸‹æ–‡
            department = em.find(Department.class, 1L);
        }
    }
    tx.commit();
} catch (Exception e) {
    tx.rollback();
    throw e;
}</code></div>
                </div>
            </div>

            <!-- ç¬¬å…­éƒ¨åˆ†ï¼šBatch å¤„ç†ä¸­çš„åº”ç”¨ -->
            <div class="section">
                <h2>âš™ï¸ ç¬¬å…­éƒ¨åˆ†ï¼šJakarta Batch ä¸­çš„åº”ç”¨</h2>
                
                <div class="subsection">
                    <h3>1. è¯»å–æ•°æ®çš„ ItemReader</h3>
                    <div class="code-block"><code>import jakarta.batch.api.chunk.ItemReader;
import jakarta.persistence.EntityManager;
import jakarta.persistence.TypedQuery;

public class UserItemReader extends ItemReader {
    private EntityManager em;
    private TypedQuery&lt;User&gt; query;
    private List&lt;User&gt; items;
    private int index = 0;
    
    @Override
    public void open(Serializable checkpoint) throws Exception {
        em = // è·å– EntityManager
        query = em.createNamedQuery("User.findAll", User.class);
        query.setFirstResult(0);
        query.setMaxResults(100); // åˆ†é¡µè¯»å–
        items = query.getResultList();
    }
    
    @Override
    public User readItem() throws Exception {
        if (index &lt; items.size()) {
            return items.get(index++);
        }
        return null;
    }
}</code></div>
                </div>

                <div class="subsection">
                    <h3>2. å¤„ç†æ•°æ®çš„ ItemProcessor</h3>
                    <div class="code-block"><code>import jakarta.batch.api.chunk.ItemProcessor;

public class UserItemProcessor extends ItemProcessor {
    
    @Override
    public User processItem(User user) throws Exception {
        // å¤„ç†æ•°æ®é€»è¾‘
        user.setAge(user.getAge() + 1);
        user.setUpdateTime(LocalDateTime.now());
        return user;
    }
}</code></div>
                </div>

                <div class="subsection">
                    <h3>3. å†™å…¥æ•°æ®çš„ ItemWriter</h3>
                    <div class="code-block"><code>import jakarta.batch.api.chunk.ItemWriter;
import jakarta.persistence.EntityManager;
import java.util.List;

public class UserItemWriter extends ItemWriter {
    private EntityManager em;
    
    @Override
    public void writeItems(List&lt;Object&gt; items) throws Exception {
        em = // è·å– EntityManager
        EntityTransaction tx = em.getTransaction();
        tx.begin();
        try {
            for (Object item : items) {
                User user = (User) item;
                em.merge(user); // æ›´æ–°
                // æˆ– em.persist(user); // æ’å…¥
            }
            em.flush();
            tx.commit();
        } catch (Exception e) {
            tx.rollback();
            throw e;
        }
    }
}</code></div>
                </div>

                <div class="subsection">
                    <h3>4. å®Œæ•´çš„ Batch Job é…ç½®</h3>
                    <div class="code-block"><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;job id="userProcessJob" xmlns="http://xmlns.jcp.org/xml/ns/javaee"&gt;
    &lt;step id="userStep"&gt;
        &lt;chunk item-count="100" skip-limit="10" retry-limit="3"&gt;
            &lt;reader ref="userItemReader"&gt;&lt;/reader&gt;
            &lt;processor ref="userItemProcessor"&gt;&lt;/processor&gt;
            &lt;writer ref="userItemWriter"&gt;&lt;/writer&gt;
        &lt;/chunk&gt;
    &lt;/step&gt;
&lt;/job&gt;</code></div>
                </div>
            </div>

            <!-- ç¬¬ä¸ƒéƒ¨åˆ†ï¼šé«˜çº§æŠ€å·§ -->
            <div class="section">
                <h2>ğŸ’¡ ç¬¬ä¸ƒéƒ¨åˆ†ï¼šé«˜çº§æŠ€å·§å’Œæœ€ä½³å®è·µ</h2>
                
                <div class="subsection">
                    <h3>1. åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–</h3>
                    <div class="code-block"><code>@NamedQuery(
    name = "User.findAllWithPagination",
    query = "SELECT u FROM User u ORDER BY u.id"
)
public class User {
    // ...
}

// ä½¿ç”¨æ–¹å¼
public List&lt;User&gt; findPagedUsers(int pageNo, int pageSize) {
    TypedQuery&lt;User&gt; query = em.createNamedQuery("User.findAllWithPagination", User.class);
    query.setFirstResult((pageNo - 1) * pageSize);
    query.setMaxResults(pageSize);
    return query.getResultList();
}</code></div>
                </div>

                <div class="subsection">
                    <h3>2. èšåˆå‡½æ•°æŸ¥è¯¢</h3>
                    <div class="code-block"><code>@NamedQuery(
    name = "User.countByDepartment",
    query = "SELECT COUNT(u) FROM User u WHERE u.department.id = :departmentId"
)
@NamedQuery(
    name = "User.averageAge",
    query = "SELECT AVG(u.age) FROM User u"
)
@NamedQuery(
    name = "User.groupByDepartment",
    query = "SELECT d.name, COUNT(u) FROM User u " +
            "GROUP BY d.id, d.name " +
            "HAVING COUNT(u) > :minCount"
)
public class User {
    // ...
}

// ä½¿ç”¨æ–¹å¼
TypedQuery&lt;Long&gt; countQuery = em.createNamedQuery("User.countByDepartment", Long.class);
countQuery.setParameter("departmentId", 1L);
Long count = countQuery.getSingleResult();</code></div>
                </div>

                <div class="subsection">
                    <h3>3. æ¡ä»¶åŠ¨æ€æŸ¥è¯¢</h3>
                    <div class="code-block"><code>public List&lt;User&gt; findUsersWithCriteria(String name, Integer minAge, Long departmentId) {
    CriteriaBuilder cb = em.getCriteriaBuilder();
    CriteriaQuery&lt;User&gt; cq = cb.createQuery(User.class);
    Root&lt;User&gt; root = cq.from(User.class);
    
    List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();
    
    if (name != null &amp;&amp; !name.isEmpty()) {
        predicates.add(cb.like(root.get("name"), "%" + name + "%"));
    }
    
    if (minAge != null) {
        predicates.add(cb.ge(root.get("age"), minAge));
    }
    
    if (departmentId != null) {
        predicates.add(cb.equal(root.get("department").get("id"), departmentId));
    }
    
    cq.where(cb.and(predicates.toArray(new Predicate[0])));
    
    return em.createQuery(cq).getResultList();
}</code></div>
                </div>

                <div class="subsection">
                    <h3>4. æ›´æ–°å’Œåˆ é™¤æ“ä½œ</h3>
                    <div class="code-block"><code>// æ‰¹é‡æ›´æ–°
public int updateUserAge(Long departmentId, Integer newAge) {
    Query query = em.createQuery(
        "UPDATE User u SET u.age = :newAge " +
        "WHERE u.department.id = :departmentId"
    );
    query.setParameter("newAge", newAge);
    query.setParameter("departmentId", departmentId);
    return query.executeUpdate();
}

// æ‰¹é‡åˆ é™¤
public int deleteInactiveUsers(LocalDateTime beforeDate) {
    Query query = em.createQuery(
        "DELETE FROM User u WHERE u.createTime &lt; :beforeDate"
    );
    query.setParameter("beforeDate", beforeDate);
    return query.executeUpdate();
}</code></div>
                </div>
            </div>

            <!-- ç¬¬å…«éƒ¨åˆ†ï¼šå¸¸è§é—®é¢˜ -->
            <div class="section">
                <h2>â“ ç¬¬å…«éƒ¨åˆ†ï¼šå¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ</h2>
                
                <div class="subsection">
                    <h3>é—®é¢˜1ï¼šæ‰¹é‡æ’å…¥æ—¶å†…å­˜æº¢å‡ºï¼Ÿ</h3>
                    <div class="description">
                        <strong>åŸå› ï¼š</strong> æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¸­ç§¯ç´¯äº†è¿‡å¤šå¯¹è±¡ã€‚
                        <br